# ID＋パスワード認証 構築案

このドキュメントは、飲食店社員ポータルに「ID＋パスワード認証」を追加する際の設計・実装案をまとめたものです。

---

## 1. 方針の整理

| 項目 | 方針 |
|------|------|
| 認証の範囲 | **サイト内で完結**（外部認証サービスは使わない） |
| ログインID | **社員ID**（メールアドレスに紐づける必要はない。必要なら後から「メールでもログイン可」に拡張可能） |
| 退職時 | **IDは削除しない**。アカウントを「無効」にし、ログイン不可にする。 |
| パスワード | 保存時は**ハッシュ化**（bcrypt）。平文は保存しない。 |

---

## 2. ユーザーデータの形

### 保存先

- **ファイル**: `data/users.json`
- 既存の `data/reports.json` などと同様に、サーバー側で読み書きする。

### 1件のユーザー（例）

```json
{
  "id": "E12345",
  "passwordHash": "$2a$10$xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "role": "staff",
  "storeId": "store-a",
  "displayName": "山田 太郎",
  "isActive": true,
  "createdAt": "2026-02-01T00:00:00.000Z",
  "updatedAt": "2026-02-01T00:00:00.000Z"
}
```

### 項目説明

| 項目 | 必須 | 説明 |
|------|------|------|
| `id` | ○ | ログインに使う社員ID。一意。 |
| `passwordHash` | ○ | パスワードを bcrypt でハッシュ化した文字列。 |
| `role` | ○ | `staff` / `manager` / `hq` のいずれか。 |
| `storeId` | △ | 所属店舗（例: `store-a`）。本部は `hq` や空でも可。 |
| `displayName` | △ | 画面に出す名前（任意）。 |
| `isActive` | ○ | `true`: ログイン可、`false`: 退職などでログイン不可。 |
| `createdAt` | △ | 作成日時。 |
| `updatedAt` | △ | 更新日時。 |

- メールアドレスは**必須にしない**。将来「パスワード再設定メール」をやりたければ、ここに `email` を追加する形で拡張する。

---

## 3. 認証の流れ

### 3.1 ログイン

1. ユーザーがログイン画面で **ID** と **パスワード** を入力。
2. フロントから `POST /api/auth/login` に `{ id, password }` を送信。
3. API 側で:
   - `data/users.json` から該当する `id` のユーザーを検索。
   - いなければ → 「IDまたはパスワードが違います」で終了。
   - `isActive === false` なら → 「このアカウントは利用できません」で終了。
   - パスワードを bcrypt で照合。不一致なら → 「IDまたはパスワードが違います」で終了。
   - 一致したら → `{ ok: true, role, userId: id }` を返す。
4. フロントでは、従来どおり **role を localStorage に保存**し、役割に応じたダッシュボードへリダイレクト。

（セッションを Cookie にしたい場合は、この段階で Cookie を設定する形に変更可能。）

### 3.2 ログアウト

- 現状どおり、localStorage の認証情報を削除してトップへ遷移。
- 必要なら「ログアウト」専用API（Cookie 削除など）を追加可能。

### 3.3 退職時（アカウント無効化）

- ユーザーを**削除せず**、該当ユーザーの `isActive` を `false` に更新する。
- 実施方法の例:
  - **A.** 本部用の「ユーザー管理」画面で一覧から「無効にする」を実行。
  - **B.** 管理用API（例: `PATCH /api/users/[id]`）で `isActive: false` を送り、`data/users.json` を更新。
- ログインAPIでは、パスワードが正しくても `isActive === false` の場合はログイン不可とする。

---

## 4. API 一覧（案）

| メソッド | パス | 説明 |
|----------|------|------|
| POST | `/api/auth/login` | ID・パスワードを検証し、成功時は `role` などを返す。 |
| GET  | `/api/auth/me` | 未使用でも可。将来「今のユーザー情報」を返す用。 |
| GET  | `/api/users` | 本部（＋店長）用。ユーザー一覧。要・権限チェック。 |
| POST | `/api/users` | 本部用。新規ユーザー追加。要・権限チェック。 |
| PATCH | `/api/users/[id]` | 本部用。`isActive` の更新など。要・権限チェック。 |

- ログインは **POST /api/auth/login** のみ必須。ユーザー管理系は「初期は JSON を手で編集し、後から画面を足す」でもよい。

---

## 5. 画面・クライアント側の変更

| 画面・箇所 | 変更内容 |
|------------|----------|
| ログイン画面 | 役割の選択を**やめる**（または「初回だけ選択」に）。ID・パスワードを送信し、`/api/auth/login` の結果でログイン可否と role を決める。 |
| ログイン失敗時 | API のメッセージ（「IDまたはパスワードが違います」「このアカウントは利用できません」）を表示。 |
| ヘッダー・リダイレクト | 現状どおり「ログイン済みか」「role」でメニューとリダイレクト先を制御。 |

---

## 6. 初期ユーザーの用意

- `data/users.json` を最初に用意する方法の例:
  - **手動**: 1件だけ JSON で定義し、パスワードは Node で bcrypt を実行して `passwordHash` を生成して貼り付け。
  - **初期化API**: 初回だけ「管理者用の秘密トークン」で `POST /api/setup/init-admin` を叩き、1人目の本部ユーザーを作成する。
- 2人目以降は、本部でログインした状態で「ユーザー追加」画面から登録する形にすると運用しやすい。

---

## 7. セキュリティ上の注意

- パスワードは **bcrypt**（または同等）でハッシュし、平文・可逆暗号で保存しない。
- 本番では **HTTPS** で運用する。
- 「IDまたはパスワードが違います」と「このアカウントは利用できません」は、攻撃者に情報を与えすぎない程度のメッセージに留める（現案の文言で可）。
- 将来的に Cookie セッションにする場合は、`httpOnly` や `secure` を検討する。

---

## 8. 実装の順序（推奨）

1. **data/users.json のスキーマ決定** と、**読む／書く**ための `src/lib/users.ts`（または既存の data 用 lib）の用意。
2. **bcrypt** の導入（`npm install bcrypt` と型 `@types/bcrypt`）、パスワードのハッシュ・照合関数の用意。
3. **POST /api/auth/login** の実装（ID 検索 → isActive チェック → パスワード照合 → role 返却）。
4. **ログイン画面**の変更（役割選択をやめ、ID・パスワード送信とエラー表示）。
5. **初期1ユーザー**を `data/users.json` に手動または初期化APIで登録し、ログインできることを確認。
6. （任意）**ユーザー管理API**（一覧・追加・無効化）と、本部用の「ユーザー管理」画面。
7. （任意）**パスワード変更**（本人がログイン後に変更する画面とAPI）。

---

## 9. まとめ

- **ID＋パスワード**はこのサイト内だけで完結できる。
- **ID はメールに紐づけなくてよい**（社員IDのみでよい）。
- **退職時は ID を削除せず、`isActive: false` でログイン不可にする。**
- ユーザーは `data/users.json` で管理し、パスワードは bcrypt でハッシュして保存する。

この案に沿って実装すれば、要件を満たす認証を追加できます。

---

## 10. 実装後の手順（初回のみ）

1. **パッケージのインストール**
   ```bash
   npm install
   ```
2. **初期ユーザー（本部・店長・一般社員）の作成**
   ```bash
   npm run seed-admin
   ```
   - 作成されるユーザー:
     - 本部: ID `admin` / パスワード `admin123`
     - 店長: ID `manager` / パスワード `manager123`
     - 一般社員: ID `staff` / パスワード `staff123`
   - 既に存在するIDはスキップされます（追加のみ）。
3. **ログイン**
   - ブラウザで `/login` を開き、上記のいずれかでログインする。
   - 本番運用では、パスワード変更を推奨する。
